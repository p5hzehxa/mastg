rules:
  - id: mastg-android-biometric-event-bound
    languages:
      - java
      - kotlin
    severity: WARNING
    metadata:
      summary: This rule detects uses of BiometricPrompt.authenticate without a CryptoObject (event-bound biometric authentication) and insecure key configurations.
    message: "[MASVS-AUTH-2] BiometricPrompt.authenticate called without a CryptoObject or key not requiring user authentication. Use authenticate(PromptInfo, CryptoObject) with a keystore-backed key configured with setUserAuthenticationRequired(true) for sensitive operations."

    pattern-either:
      # Pattern 1: BiometricPrompt.authenticate() without CryptoObject (event-bound authentication)
      - patterns:
          - pattern: $INSTANCE.authenticate($PROMPT_INFO)
          - pattern-not: $ANY.authenticate($PROMPT_INFO, $CRYPTO_OBJECT)

      # Pattern 2: KeyGenParameterSpec.Builder without setUserAuthenticationRequired(true)
      - patterns:
          - pattern: new KeyGenParameterSpec.Builder(...)
          - pattern-not-inside: |
              new KeyGenParameterSpec.Builder(...). ... .setUserAuthenticationRequired(true)
